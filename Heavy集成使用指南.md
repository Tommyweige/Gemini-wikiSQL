# WikiSQL Heavyé›†æˆä½¿ç”¨æŒ‡å—

## ğŸ¯ æ¦‚è¿°

WikiSQL Heavyé›†æˆå°†"Make It Heavy"çš„å¤šæ™ºèƒ½ä½“åˆ†æç³»ç»Ÿæ•´åˆåˆ°WikiSQLé¡¹ç›®ä¸­ï¼Œæä¾›æ·±åº¦SQLæŸ¥è¯¢åˆ†æå’ŒéªŒè¯åŠŸèƒ½ã€‚

## âœ¨ æ ¸å¿ƒç‰¹æ€§

### ğŸ§  å¤šæ™ºèƒ½ä½“SQLåˆ†æ
- **SQLè¯­æ³•ä¸“å®¶**: ä¸“æ³¨è¯­æ³•æ­£ç¡®æ€§å’Œä¼˜åŒ–
- **æ•°æ®åˆ†æå¸ˆ**: ä¸“æ³¨æŸ¥è¯¢é€»è¾‘å’Œæ•°æ®ç†è§£  
- **æ€§èƒ½ä¼˜åŒ–å¸ˆ**: ä¸“æ³¨æŸ¥è¯¢æ€§èƒ½å’Œæ•ˆç‡
- **ç»“æœéªŒè¯å¸ˆ**: ä¸“æ³¨ç»“æœå‡†ç¡®æ€§å’ŒéªŒè¯

### ğŸ” æ·±åº¦åˆ†æåŠŸèƒ½
- **å¹¶è¡Œåˆ†æ**: 4ä¸ªä¸“é—¨æ™ºèƒ½ä½“åŒæ—¶åˆ†æ
- **ç½®ä¿¡åº¦è¯„ä¼°**: é‡åŒ–åˆ†æå¯é æ€§
- **ç»¼åˆå»ºè®®**: æ•´åˆå¤šè§’åº¦å»ºè®®
- **é”™è¯¯æ£€æµ‹**: å¤šå±‚éªŒè¯æœºåˆ¶

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–
```bash
pip install -r requirements.txt
```

### 2. é…ç½®APIå¯†é’¥

#### WikiSQL APIå¯†é’¥
ç”¨äºåŸºç¡€LLMåŠŸèƒ½ï¼ˆGemini 2.5 Flashï¼‰

#### OpenRouter APIå¯†é’¥
ç”¨äºHeavyå¤šæ™ºèƒ½ä½“åˆ†æï¼Œéœ€è¦åœ¨ä»¥ä¸‹ä½ç½®é…ç½®ï¼š

**æ–¹æ³•1: ç¯å¢ƒå˜é‡**
```bash
export OPENROUTER_API_KEY="your_openrouter_key"
```

**æ–¹æ³•2: ä¿®æ”¹é…ç½®æ–‡ä»¶**
ç¼–è¾‘ `make-it-heavy/config.yaml`:
```yaml
openrouter:
  api_key: "your_openrouter_key"
  model: "google/gemini-2.5-flash-preview-05-20"
```

### 3. æµ‹è¯•é›†æˆ
```bash
python test_heavy_integration.py
```

## ğŸ“– ä½¿ç”¨æ–¹æ³•

### åŸºç¡€ä½¿ç”¨
```python
from wikisql_heavy_integration import WikiSQLDirectLLMHeavy

# åˆå§‹åŒ–HeavyåŠ©æ‰‹
assistant = WikiSQLDirectLLMHeavy(api_key="your_wikisql_key")

# åŠ è½½æ•°æ®é›†
assistant.load_wikisql_dataset("dev", limit=10)

# æ£€æŸ¥Heavyæ¨¡å¼çŠ¶æ€
if assistant.heavy_enabled:
    print("âœ… Heavyæ¨¡å¼å¯ç”¨")
else:
    print("âš ï¸ Heavyæ¨¡å¼ä¸å¯ç”¨ï¼Œä½¿ç”¨åŸºç¡€æ¨¡å¼")
```

### HeavyæŸ¥è¯¢
```python
# æ‰§è¡ŒHeavyåˆ†ææŸ¥è¯¢
heavy_result = assistant.query_with_heavy(
    "What is the position of player number 23?"
)

# æŸ¥çœ‹åˆ†æç»“æœ
if heavy_result.get("heavy_analysis"):
    analysis = heavy_result["heavy_analysis"]
    
    print(f"ç½®ä¿¡åº¦: {analysis['overall_confidence']:.2f}")
    print(f"å»ºè®®æ•°é‡: {len(analysis['final_recommendations'])}")
    
    # æŸ¥çœ‹æ™ºèƒ½ä½“åˆ†æ
    for agent_result in analysis["agent_analyses"]:
        print(f"æ™ºèƒ½ä½“ {agent_result['agent_id']}: {agent_result['role']}")
        print(f"ç½®ä¿¡åº¦: {agent_result.get('confidence', 0.0):.2f}")
```

### ä»…SQLç”Ÿæˆå’Œåˆ†æ
```python
# åªè¿›è¡ŒSQLç”Ÿæˆå’ŒHeavyåˆ†æï¼Œä¸æ‰§è¡ŒæŸ¥è¯¢
sql_analysis = assistant.generate_sql_with_heavy_analysis(
    question="How many players are there?",
    table_id="table_123"
)

print(f"ç”Ÿæˆçš„SQL: {sql_analysis['basic_sql']}")

if sql_analysis.get("heavy_analysis"):
    analysis = sql_analysis["heavy_analysis"]
    print(f"Heavyåˆ†æç½®ä¿¡åº¦: {analysis['overall_confidence']:.2f}")
```

## ğŸ”§ é…ç½®é€‰é¡¹

### Heavyæ¨¡å¼é…ç½®
åœ¨ `make-it-heavy/config.yaml` ä¸­é…ç½®ï¼š

```yaml
# æ™ºèƒ½ä½“è®¾ç½®
agent:
  max_iterations: 10

# ç¼–æ’å™¨è®¾ç½®  
orchestrator:
  parallel_agents: 4      # å¹¶è¡Œæ™ºèƒ½ä½“æ•°é‡
  task_timeout: 300       # æ¯ä¸ªæ™ºèƒ½ä½“è¶…æ—¶æ—¶é—´(ç§’)
  aggregation_strategy: "consensus"

# æ¨¡å‹è®¾ç½®
openrouter:
  model: "google/gemini-2.5-flash-preview-05-20"  # æ¨èé«˜ä¸Šä¸‹æ–‡æ¨¡å‹
```

### æ™ºèƒ½ä½“è§’è‰²
ç³»ç»Ÿè‡ªåŠ¨åˆ†é…4ä¸ªä¸“é—¨è§’è‰²ï¼š
- **æ™ºèƒ½ä½“0**: SQLè¯­æ³•ä¸“å®¶
- **æ™ºèƒ½ä½“1**: æ•°æ®åˆ†æå¸ˆ  
- **æ™ºèƒ½ä½“2**: æ€§èƒ½ä¼˜åŒ–å¸ˆ
- **æ™ºèƒ½ä½“3**: ç»“æœéªŒè¯å¸ˆ

## ğŸ“Š è¾“å‡ºæ ¼å¼

### Heavyåˆ†æç»“æœç»“æ„
```python
{
    "question": "åŸå§‹é—®é¢˜",
    "generated_sql": "ç”Ÿæˆçš„SQL",
    "agent_analyses": [
        {
            "agent_id": 0,
            "role": "SQLè¯­æ³•ä¸“å®¶",
            "analysis": "è¯¦ç»†åˆ†æå†…å®¹",
            "confidence": 0.85,
            "recommendations": ["å»ºè®®1", "å»ºè®®2"]
        }
        # ... å…¶ä»–æ™ºèƒ½ä½“ç»“æœ
    ],
    "synthesis": {
        "confidence": 0.82,
        "recommendations": ["ç»¼åˆå»ºè®®1", "ç»¼åˆå»ºè®®2"],
        "summary": "ç»¼åˆè¯„ä¼°æ‘˜è¦",
        "valid_analyses": 4,
        "total_agents": 4
    },
    "overall_confidence": 0.82,
    "final_recommendations": ["æœ€ç»ˆå»ºè®®åˆ—è¡¨"]
}
```

## ğŸ¯ ä½¿ç”¨åœºæ™¯

### é€‚åˆHeavyåˆ†æçš„æƒ…å†µ
- âœ… **å¤æ‚æŸ¥è¯¢**: å¤šè¡¨è¿æ¥ã€å¤æ‚æ¡ä»¶
- âœ… **å…³é”®ä¸šåŠ¡**: éœ€è¦é«˜å‡†ç¡®ç‡çš„æŸ¥è¯¢
- âœ… **è°ƒè¯•åˆ†æ**: æŸ¥è¯¢ç»“æœå¼‚å¸¸éœ€è¦æ·±åº¦åˆ†æ
- âœ… **å­¦ä¹ ç ”ç©¶**: äº†è§£SQLæŸ¥è¯¢çš„å¤šè§’åº¦åˆ†æ

### é€‚åˆåŸºç¡€æ¨¡å¼çš„æƒ…å†µ
- âœ… **ç®€å•æŸ¥è¯¢**: å•è¡¨æŸ¥è¯¢ã€åŸºç¡€æ¡ä»¶
- âœ… **æ‰¹é‡å¤„ç†**: å¤§é‡æŸ¥è¯¢éœ€è¦å¿«é€Ÿå¤„ç†
- âœ… **èµ„æºå—é™**: APIé…é¢æˆ–æ—¶é—´é™åˆ¶
- âœ… **åŸå‹å¼€å‘**: å¿«é€ŸéªŒè¯æƒ³æ³•

## âš¡ æ€§èƒ½å¯¹æ¯”

| ç‰¹æ€§ | åŸºç¡€æ¨¡å¼ | Heavyæ¨¡å¼ |
|------|----------|-----------|
| **é€Ÿåº¦** | å¿« (~5ç§’) | æ…¢ (~30-60ç§’) |
| **å‡†ç¡®ç‡** | 79%+ | é¢„æœŸ85%+ |
| **åˆ†ææ·±åº¦** | åŸºç¡€ | æ·±åº¦å¤šè§’åº¦ |
| **APIæ¶ˆè€—** | ä½ | é«˜ (4å€) |
| **é€‚ç”¨åœºæ™¯** | æ—¥å¸¸ä½¿ç”¨ | é‡è¦æŸ¥è¯¢ |

## ğŸ› ï¸ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. Heavyæ¨¡å¼ä¸å¯ç”¨
```
âš ï¸ Heavyæ¨¡å¼åˆå§‹åŒ–å¤±è´¥
```
**è§£å†³æ–¹æ¡ˆ**:
- æ£€æŸ¥OpenRouter APIå¯†é’¥æ˜¯å¦æ­£ç¡®
- ç¡®è®¤make-it-heavyç›®å½•å­˜åœ¨
- éªŒè¯config.yamlé…ç½®æ–‡ä»¶

#### 2. æ™ºèƒ½ä½“åˆ†æå¤±è´¥
```
âŒ æ™ºèƒ½ä½“ X åˆ†æå¤±è´¥
```
**è§£å†³æ–¹æ¡ˆ**:
- æ£€æŸ¥ç½‘ç»œè¿æ¥
- éªŒè¯APIé…é¢
- æŸ¥çœ‹é”™è¯¯æ—¥å¿—è¯¦æƒ…

#### 3. é…ç½®æ–‡ä»¶é”™è¯¯
```
âŒ åŠ è½½é…ç½®æ–‡ä»¶å¤±è´¥
```
**è§£å†³æ–¹æ¡ˆ**:
- ç¡®è®¤config.yamlæ–‡ä»¶å­˜åœ¨
- æ£€æŸ¥YAMLè¯­æ³•æ­£ç¡®æ€§
- éªŒè¯æ–‡ä»¶æƒé™

### è°ƒè¯•æŠ€å·§

#### å¯ç”¨è¯¦ç»†æ—¥å¿—
```python
import logging
logging.basicConfig(level=logging.DEBUG)
```

#### æ£€æŸ¥HeavyçŠ¶æ€
```python
if not assistant.heavy_enabled:
    print("Heavyæ¨¡å¼æœªå¯ç”¨åŸå› :")
    # æ£€æŸ¥é…ç½®å’Œä¾èµ–
```

#### å•ç‹¬æµ‹è¯•æ™ºèƒ½ä½“
```python
# æµ‹è¯•å•ä¸ªæ™ºèƒ½ä½“
from wikisql_heavy_integration import WikiSQLHeavyAgent

agent = WikiSQLHeavyAgent(0, config)
result = agent.analyze_sql_query(question, table_info, sql)
```

## ğŸ“ˆ æœ€ä½³å®è·µ

### 1. åˆç†ä½¿ç”¨Heavyæ¨¡å¼
- å¯¹é‡è¦æŸ¥è¯¢ä½¿ç”¨Heavyåˆ†æ
- æ‰¹é‡å¤„ç†æ—¶ä½¿ç”¨åŸºç¡€æ¨¡å¼
- æ ¹æ®æ—¶é—´å’Œèµ„æºé™åˆ¶é€‰æ‹©

### 2. ä¼˜åŒ–é…ç½®
- é€‰æ‹©é«˜ä¸Šä¸‹æ–‡çª—å£æ¨¡å‹
- è°ƒæ•´è¶…æ—¶æ—¶é—´é€‚åº”ç½‘ç»œç¯å¢ƒ
- æ ¹æ®éœ€è¦è°ƒæ•´æ™ºèƒ½ä½“æ•°é‡

### 3. ç»“æœè§£è¯»
- å…³æ³¨ç»¼åˆç½®ä¿¡åº¦
- é‡è§†å¤šæ™ºèƒ½ä½“ä¸€è‡´æ€§å»ºè®®
- ç»“åˆä¸šåŠ¡é€»è¾‘åˆ¤æ–­

## ğŸ”® æœªæ¥æ‰©å±•

### è®¡åˆ’åŠŸèƒ½
- **è‡ªå®šä¹‰æ™ºèƒ½ä½“è§’è‰²**: æ”¯æŒç‰¹å®šé¢†åŸŸä¸“å®¶
- **å­¦ä¹ ä¼˜åŒ–**: åŸºäºå†å²åˆ†ææ”¹è¿›
- **å¯è§†åŒ–åˆ†æ**: å›¾å½¢åŒ–å±•ç¤ºåˆ†æç»“æœ
- **æ‰¹é‡Heavyåˆ†æ**: æ”¯æŒæ‰¹é‡æ·±åº¦åˆ†æ

### é›†æˆå¯èƒ½æ€§
- **ä¸éªŒè¯å™¨é›†æˆ**: Heavyåˆ†æç»“æœç”¨äºéªŒè¯
- **ä¸é¢„æµ‹ç”Ÿæˆé›†æˆ**: Heavyæ¨¡å¼ç”Ÿæˆé¢„æµ‹æ–‡ä»¶
- **ä¸è¯„ä¼°ç³»ç»Ÿé›†æˆ**: Heavyåˆ†ææ”¹è¿›è¯„ä¼°å‡†ç¡®ç‡

## ğŸ‰ æ€»ç»“

WikiSQL Heavyé›†æˆä¸ºSQLæŸ¥è¯¢åˆ†ææä¾›äº†å¼ºå¤§çš„å¤šæ™ºèƒ½ä½“æ”¯æŒï¼Œåœ¨ä¿æŒåŸæœ‰ç®€æ´æ€§çš„åŒæ—¶ï¼Œä¸ºéœ€è¦æ·±åº¦åˆ†æçš„åœºæ™¯æä¾›äº†ä¸“ä¸šçº§çš„åˆ†æèƒ½åŠ›ã€‚

**é€‰æ‹©å»ºè®®**:
- **æ—¥å¸¸ä½¿ç”¨**: åŸºç¡€æ¨¡å¼ (å¿«é€Ÿã€ç»æµ)
- **é‡è¦æŸ¥è¯¢**: Heavyæ¨¡å¼ (æ·±åº¦ã€å‡†ç¡®)
- **æ··åˆä½¿ç”¨**: æ ¹æ®å…·ä½“éœ€æ±‚çµæ´»é€‰æ‹©